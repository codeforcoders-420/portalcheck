<script>
(function() {
  // prevent double-init if script is included twice
  if (window.__scfAutoInitDone) {
    return;
  }
  window.__scfAutoInitDone = true;

  window.addEventListener('DOMContentLoaded', function() {
    // --- DOM elements ---
    const fileInput = document.getElementById('scfFileInput');
    const hidden    = document.getElementById('scfSelectedAbsolute');
    const hint      = document.getElementById('scfHint');
    const modal     = document.getElementById('scfModal');
    const modalText = document.getElementById('scfModalText');
    const useBtn    = document.getElementById('scfUseBtn');
    const browseBtn = document.getElementById('scfBrowseBtn');

    // If this page doesn't have these elements, bail out quietly
    if (!fileInput || !hidden || !hint || !modal || !modalText || !useBtn || !browseBtn) {
      return;
    }

    function ctxFromUrl() {
      const url = new URL(window.location.href);

      let year = url.searchParams.get('year');
      let lob  = url.searchParams.get('lob');
      let fs   = url.searchParams.get('feeSchedule') || url.searchParams.get('fs');
      let tfs  = url.searchParams.get('tfs')
              || url.searchParams.get('story')
              || url.searchParams.get('storyNumber')   // your param
              || url.searchParams.get('tfsId');

      // hash fallback
      if (!year || !lob || !fs || !tfs) {
        const hash = new URLSearchParams(url.hash.startsWith('#') ? url.hash.slice(1) : url.hash);
        year = year || hash.get('year');
        lob  = lob  || hash.get('lob');
        fs   = fs   || hash.get('feeSchedule') || hash.get('fs');
        tfs  = tfs  || hash.get('tfs') || hash.get('storyNumber') || hash.get('story') || hash.get('tfsId');
      }

      return { year, lob, fs, tfs };
    }

    const ctx = ctxFromUrl();

    // If missing URL pieces → no auto-select
    if (!ctx.year || !ctx.lob || !ctx.fs || !ctx.tfs) {
      hidden.value = '';
      fileInput.disabled = false;
      hint.textContent = 'Missing Year/LOB/FS/TFS in URL—please choose a file manually.';
      return;
    }

    // Show a subtle “checking…” message but DO NOT show modal yet
    hint.textContent = 'Checking for Standard Change File…';

    // Probe backend once
    fetch(`/api/scf/probe?year=${encodeURIComponent(ctx.year)}&lob=${encodeURIComponent(ctx.lob)}&fs=${encodeURIComponent(ctx.fs)}&storyNumber=${encodeURIComponent(ctx.tfs)}`)
      .then(r => r.json())
      .then(data => {
        if (!data.hasAny) {
          hidden.value = '';
          fileInput.disabled = false;
          hint.textContent = `No Standard Change File found in: ${data.folder}. Please browse manually.`;
          return;
        }

        const latest = data.latest;
        const lm = new Date(latest.lastModified).toLocaleString();
        modalText.textContent = `${latest.name} (modified ${lm}) in ${data.folder}`;

        // Only now show modal ONCE
        modal.style.display = 'block';

        useBtn.onclick = () => {
          hidden.value = latest.absolutePath;
          fileInput.value = '';
          fileInput.disabled = true;
          hint.textContent = `Using (auto-selected): ${latest.name}`;
          modal.style.display = 'none';
        };

        browseBtn.onclick = () => {
          hidden.value = '';
          fileInput.disabled = false;
          hint.textContent = 'Choose a file manually.';
          modal.style.display = 'none';
        };
      })
      .catch(err => {
        console.error(err);
        hidden.value = '';
        fileInput.disabled = false;
        hint.textContent = 'Could not probe the Standard Change File folder. Please browse manually.';
      });
  });
})();
</script>
