import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

import java.io.*;
import java.text.DecimalFormat;
import java.util.*;

public class MCAHCScrubber {

    public static void main(String[] args) {
        String inputFolder = "C:/your_path/Input/";
        String outputFolder = "C:/your_path/Output/";

        File[] files = new File(inputFolder).listFiles((dir, name) -> name.endsWith(".xlsx") || name.endsWith(".xls"));
        if (files == null || files.length == 0) {
            System.out.println("No input files found.");
            return;
        }

        for (File file : files) {
            try (FileInputStream fis = new FileInputStream(file);
                 Workbook workbook = new XSSFWorkbook(fis)) {

                Sheet sheet = workbook.getSheetAt(0);
                int headerRowIndex = findHeaderRow(sheet);
                if (headerRowIndex == -1) {
                    System.out.println("Header not found in file: " + file.getName());
                    continue;
                }

                if (file.getName().contains("MCAHC MAN")) {
                    // File 2 logic
                    List<List<String>> filtered = processFile2(sheet, headerRowIndex);
                    writeFilteredDataToExcel(filtered, outputFolder + "MI_MD_MCAHC_MAN_Output.xlsx");
                } else {
                    // File 1 logic
                    List<List<String>> filtered = processFile1(sheet, headerRowIndex);
                    writeFilteredDataToExcel(filtered, outputFolder + "MI_MD_MCAHC_U21_Output.xlsx");
                }

                System.out.println("Processed: " + file.getName());

            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    // ------------------ FILE 1 -----------------------
    private static List<List<String>> processFile1(Sheet sheet, int headerRowIndex) {
        List<List<String>> filteredRows = new ArrayList<>();
        Row headerRow = sheet.getRow(headerRowIndex);
        filteredRows.add(getStringRow(headerRow));

        for (int i = headerRowIndex + 1; i <= sheet.getLastRowNum(); i++) {
            Row row = sheet.getRow(i);
            if (row == null) continue;

            List<String> stringRow = getStringRow(row);
            if (shouldIncludeRow(stringRow)) {
                filteredRows.add(stringRow);
            }
        }
        return filteredRows;
    }

    private static boolean shouldIncludeRow(List<String> row) {
        String rateStr = row.get(3).trim(); // Assuming Rate is at index 3
        String ageRange = row.get(2).trim(); // Assuming Age Range is at index 2

        if (rateStr.equalsIgnoreCase("M") || rateStr.equalsIgnoreCase("$0") || rateStr.equalsIgnoreCase("$0.00") || rateStr.equalsIgnoreCase("0") || rateStr.equalsIgnoreCase("0.0000"))
            return false;

        if (ageRange.isBlank()) return true;

        return !isUnder21(ageRange);
    }

    // ------------------ FILE 2 -----------------------
    private static List<List<String>> processFile2(Sheet sheet, int headerRowIndex) {
        List<List<String>> filteredRows = new ArrayList<>();
        Row headerRow = sheet.getRow(headerRowIndex);
        filteredRows.add(getStringRow(headerRow));

        for (int i = headerRowIndex + 1; i <= sheet.getLastRowNum(); i++) {
            Row row = sheet.getRow(i);
            if (row == null) continue;

            List<String> rowData = getStringRow(row);
            String rateVal = rowData.get(3).trim();
            if (rateVal.equalsIgnoreCase("M")) {
                rowData.set(3, "0.0100");
                filteredRows.add(rowData);
            }
        }

        return filteredRows;
    }

    // ------------------ UTILITIES -----------------------

    private static boolean isUnder21(String ageRange) {
        try {
            String[] parts = ageRange.split(" ");
            for (String part : parts) {
                try {
                    int age = Integer.parseInt(part);
                    if (age < 21) return true;
                } catch (NumberFormatException ignored) {
                }
            }
        } catch (Exception e) {
            return true;
        }
        return false;
    }

    private static List<String> getStringRow(Row row) {
        List<String> values = new ArrayList<>();
        DataFormatter formatter = new DataFormatter();

        for (int i = 0; i < row.getLastCellNum(); i++) {
            Cell cell = row.getCell(i);
            String value = formatter.formatCellValue(cell);

            // Remove .0 from Code column (assume Code is column 0)
            if (i == 0 && value.matches("\\d+\\.0")) {
                value = value.substring(0, value.indexOf('.'));
            }

            // Format Rate column (assume Rate is column 3)
            if (i == 3) {
                try {
                    double rate = Double.parseDouble(value.replace("$", ""));
                    value = new DecimalFormat("0.0000").format(rate);
                } catch (NumberFormatException e) {
                    // Keep original if not a number
                }
            }

            values.add(value);
        }

        return values;
    }

    private static int findHeaderRow(Sheet sheet) {
        for (int i = 0; i <= sheet.getLastRowNum(); i++) {
            Row row = sheet.getRow(i);
            if (row == null) continue;
            for (Cell cell : row) {
                String val = cell.getStringCellValue().trim().toLowerCase();
                if (val.contains("code") && val.contains("rate")) return i;
            }
        }
        return -1;
    }

    private static void writeFilteredDataToExcel(List<List<String>> data, String filePath) {
        try (Workbook wb = new XSSFWorkbook()) {
            Sheet sheet = wb.createSheet("Output");
            for (int r = 0; r < data.size(); r++) {
                Row row = sheet.createRow(r);
                List<String> rowData = data.get(r);
                for (int c = 0; c < rowData.size(); c++) {
                    Cell cell = row.createCell(c);
                    cell.setCellValue(rowData.get(c));
                }
            }
            try (FileOutputStream out = new FileOutputStream(filePath)) {
                wb.write(out);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
